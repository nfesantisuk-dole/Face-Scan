<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'mac-primary': '#4F46E5', // Indigo
            'mac-bg': '#F3F4F6',
            'mac-card': 'rgba(255, 255, 255, 0.9)',
          },
          borderRadius: {
            'xl': '12px',
            '2xl': '16px',
          },
          boxShadow: {
            'mac-light': '0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08)',
            'mac-lg': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
            'mac-inset': 'inset 1px 1px 3px rgba(0,0,0,0.05), inset -1px -1px 3px rgba(255,255,255,0.7)',
          },
        }
      }
    }
  </script>

  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      background-color: #F3F4F6;
    }
    .form-control-mac:focus {
      outline: 2px solid #4F46E5 !important;
      outline-offset: 1px;
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2) !important;
      border-color: #4F46E5 !important;
    }
    .btn-mac:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .btn-mac:active {
      transform: scale(0.98);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    .d-none {
        display: none !important;
    }
  </style>

</head>
<body class="p-4 sm:p-8 bg-mac-bg flex min-h-screen flex-col items-center justify-center">
  <div class="container mx-auto p-4 w-full">
    <div class="bg-mac-card backdrop-blur-md rounded-2xl shadow-mac-lg overflow-hidden border border-gray-100 transition-all duration-300">
      
      <div class="p-4 sm:p-6 bg-gray-50/50 border-b border-gray-200/50 relative">
        <div class="flex space-x-2 absolute top-4 left-4">
          <div class="w-3 h-3 bg-red-500 rounded-full hover:bg-red-600 transition duration-150"></div>
          <div class="w-3 h-3 bg-yellow-500 rounded-full hover:bg-yellow-600 transition duration-150"></div>
          <div class="w-3 h-3 bg-green-500 rounded-full hover:bg-green-600 transition duration-150"></div>
        </div>

        <div class="text-center pt-1">
            <div class="text-xl sm:text-2xl font-bold text-gray-800 tracking-wide">
              <i class="fa-brands fa-searchengin text-mac-primary"></i> 
              ระบบติดตามสถานะเอกสารใบระเบียนแสดงผลการเรียน
            </div>
            <div class="text-sm sm:text-base text-gray-500 mt-1">
              <span class="font-medium text-indigo-600">สกร.ระดับอำเภอดอยหล่อ</span>
            </div>
        </div>
      </div>
      
      <div class="p-6 sm:p-8 flex-1">
        
        <form id="search-form" onsubmit="handleFormSubmit(this)" class="space-y-4">
          
          <div class="text-sm sm:text-base text-center text-gray-600">
            ศกร.ระดับตำบลสันติสุข : สกร.ระดับอำเภอดอยหล่อ
          </div>

          <div class="flex justify-center">
            <div class="w-full md:w-3/4">
              <input type="text" class="form-control-mac w-full p-3 text-base sm:text-lg border border-gray-300 rounded-lg shadow-mac-inset focus:ring-mac-primary focus:border-mac-primary transition duration-200"
                id="searchtext" name="searchtext" placeholder="พิมพ์ชื่อเพื่อค้นหา">
            </div>
          </div>

          <div class="flex justify-center pt-2">
            <button id="search" type="submit" class="btn-mac flex items-center justify-center space-x-2 px-6 py-3 text-white bg-mac-primary rounded-xl font-semibold shadow-mac-light hover:bg-indigo-600 transition duration-300">
              <span id="button-text" class="text-sm sm:text-base">ค้นหา</span>
              <span id="spinner" class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin d-none" role="status" aria-hidden="true"></span>
            </button>
          </div>
          
        </form>
        
        <div id="search-results" class="table-responsive mt-8 pt-4 border-t border-gray-200">
          <div class="text-sm sm:text-base text-center text-gray-500 italic">
            ผลการค้นหาจะปรากฏที่นี่
          </div>
        </div>

      </div>

      <div class="p-4 sm:p-6 bg-gray-50/50 border-t border-gray-200/50 text-center text-xs sm:text-sm text-gray-600 rounded-b-2xl">
        <a target="_blank" href="https://sites.google.com/cmi.nfe.go.th/nfesantisuk">
          <i class="fas fa-chalkboard-teacher text-indigo-600"></i> 
          พัฒนาระบบโดย : ครูยุรนันท์ ขันแข่งบุญ ศกร.ระดับตำบลสันติสุข
        </a>
      </div>

    </div>
  </div>

  <script>
    // ป้องกันการ Submit form แบบดั้งเดิม
    function preventFormSubmit() {
      var forms = document.querySelectorAll('form');
      for (var i = 0; i < forms.length; i++) {
        forms[i].addEventListener('submit', function(event) {
          event.preventDefault();
        });
      }
    }
    window.addEventListener("load", preventFormSubmit, true); 
    
    // จัดการการ Submit form และเรียก Apps Script
    function handleFormSubmit(formObject) {
      const searchButtonText = document.getElementById('button-text');
      const spinner = document.getElementById('spinner');
      
      searchButtonText.textContent = "กำลังโหลดข้อมูล";
      spinner.classList.remove("d-none");
      spinner.classList.add("inline-block");
      
      // เรียก Apps Script function และกำหนด Success Handler
      google.script.run.withSuccessHandler(createTable).processForm(formObject);
    }

    // ฟังก์ชัน: กำหนดสไตล์สำหรับ "สถานะเอกสาร" (Index 3)
    function getStatusStyles(statusText) {
      if (!statusText) return { text: 'text-gray-600', bg: 'bg-gray-100', icon: 'fas fa-minus-circle' };
      
      const lowerStatus = statusText.toLowerCase();
      
      if (lowerStatus.includes('พร้อมส่ง') || lowerStatus.includes('เรียบร้อย') || lowerStatus.includes('สำเร็จ')) {
        return { text: 'text-green-800', bg: 'bg-green-100', icon: 'fas fa-check-circle' };
      } else if (lowerStatus.includes('รอตรวจสอบ') || lowerStatus.includes('รออนุมัติ') || lowerStatus.includes('กำลังดำเนินการ')) {
        return { text: 'text-yellow-800', bg: 'bg-yellow-100', icon: 'fas fa-hourglass-half' };
      } else if (lowerStatus.includes('ไม่ผ่าน') || lowerStatus.includes('ไม่สมบูรณ์') || lowerStatus.includes('ต้องแก้ไข')) {
        return { text: 'text-red-800', bg: 'bg-red-100', icon: 'fas fa-times-circle' };
      } else {
        return { text: 'text-blue-800', bg: 'bg-blue-100', icon: 'fas fa-info-circle' };
      }
    }

    // ฟังก์ชัน: กำหนดสไตล์สำหรับ "การดำเนินการ" (Index 4)
    function getActionStyles(actionText) {
      if (!actionText) return { text: 'text-gray-600', bg: 'bg-gray-100', icon: 'fas fa-ban' };

      const lowerAction = actionText.toLowerCase();

      if (lowerAction.includes('จัดทำ') || lowerAction.includes('พิมพ์') || lowerAction.includes('กำลังสร้าง')) {
        return { text: 'text-blue-800', bg: 'bg-blue-100', icon: 'fas fa-print' };
      } else if (lowerAction.includes('นำเสนอ') || lowerAction.includes('อนุมัติ')) {
        return { text: 'text-indigo-800', bg: 'bg-indigo-100', icon: 'fas fa-user-check' };
      } else if (lowerAction.includes('รอรับ') || lowerAction.includes('แจ้งแล้ว')) {
        return { text: 'text-orange-800', bg: 'bg-orange-100', icon: 'fas fa-handshake' };
      } else if (lowerAction.includes('เสร็จสิ้น') || lowerAction.includes('จบ')) {
        return { text: 'text-green-800', bg: 'bg-green-100', icon: 'fas fa-flag-checkered' };
      } else {
        return { text: 'text-gray-700', bg: 'bg-gray-200', icon: 'fas fa-ellipsis-h' };
      }
    }


    // สร้างตารางผลลัพธ์การค้นหา
    function createTable(dataArray) {
      const searchButtonText = document.getElementById('button-text');
      const spinner = document.getElementById('spinner');
      
      // ซ่อน Spinner และคืนข้อความปุ่ม
      searchButtonText.textContent = "ค้นหา";
      spinner.classList.remove("inline-block");
      spinner.classList.add("d-none");
      
      const div = document.getElementById('search-results');
      
      if (dataArray && dataArray.length > 0) {
        let result = `<div class="overflow-x-auto">
                      <table class="min-w-full divide-y divide-gray-200 shadow-lg rounded-lg overflow-hidden">
                        <thead class="bg-mac-primary text-white">
                          <tr>
                            <th scope="col" class="px-4 py-3 text-sm sm:text-base font-semibold uppercase tracking-wider">ชื่อ-สกุล</th>
                            <th scope="col" class="px-4 py-3 text-sm sm:text-base font-semibold uppercase tracking-wider">รหัสนักศึกษา</th>
                            <th scope="col" class="px-4 py-3 text-sm sm:text-base font-semibold uppercase tracking-wider">ระดับการศึกษา</th>
                            <th scope="col" class="px-4 py-3 text-sm sm:text-base font-semibold uppercase tracking-wider">สถานะเอกสาร</th>
                            <th scope="col" class="px-4 py-3 text-sm sm:text-base font-semibold uppercase tracking-wider">การดำเนินการ</th>
                            <th scope="col" class="px-4 py-3 text-sm sm:text-base font-semibold uppercase tracking-wider">ผู้รับผิดชอบ</th>
                          </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">`;
        
        dataArray.forEach((row, rowIndex) => {
          const rowClass = rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50';
          result += `<tr class="${rowClass} hover:bg-mac-bg transition duration-150">`;

          row.forEach((cell, cellIndex) => {
            let cellContent = `<td class="px-4 py-3 whitespace-nowrap text-sm sm:text-base text-gray-800">${cell}</td>`;

            // Index 3: สถานะเอกสาร (คอลัมน์ที่ 4)
            if (cellIndex === 3) {
                const status = row[3];
                const styles = getStatusStyles(status);
                
                // สร้าง Badge สถานะเอกสาร
                cellContent = `
                  <td class="px-4 py-3 whitespace-nowrap text-sm sm:text-base text-gray-800">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm sm:text-base font-medium ${styles.bg} ${styles.text}">
                      <i class="${styles.icon} mr-1"></i>
                      ${status}
                    </span>
                  </td>`;
            } 
            // Index 4: การดำเนินการ (คอลัมน์ที่ 5)
            else if (cellIndex === 4) {
                const action = row[4];
                const styles = getActionStyles(action);
                
                // สร้าง Badge การดำเนินการ
                cellContent = `
                  <td class="px-4 py-3 whitespace-nowrap text-sm sm:text-base text-gray-800">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm sm:text-base font-medium ${styles.bg} ${styles.text}">
                      <i class="${styles.icon} mr-1"></i>
                      ${action}
                    </span>
                  </td>`;
            }

            result += cellContent;
          });
          result += `</tr>`;
        });
        
        result += `</tbody></table></div>`;
        div.innerHTML = result;
      } else {
        // ไม่พบข้อมูล
        div.innerHTML = `<div class="p-6 text-center text-lg sm:text-xl font-medium text-red-500 bg-red-50 border border-red-200 rounded-xl">
                          <i class="fas fa-exclamation-circle mr-2"></i> ไม่พบข้อมูลที่ต้องการค้นหา!
                        </div>`;
      }
    }
  </script>
</body>
</html>
